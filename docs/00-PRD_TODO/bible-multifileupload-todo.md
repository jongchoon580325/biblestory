# 성경 자료 다중 파일 업로드 TODO 리스트

## 개요

기존 단일 파일 업로드의 한계를 해결하고, 파일명 패턴에서 장 번호를 자동 추출하여 다중 파일 일괄 업로드 기능을 구현하는 TODO 리스트입니다.

### 목표
- **일괄 업로드**: 한 번에 여러 파일 선택 가능
- **자동 매핑**: 선택된 파일들을 자동으로 장별로 매핑
- **일괄 처리**: 한 번의 업로드로 모든 파일을 DB에 저장
- **사용자 경험 향상**: 직관적인 인터페이스와 실시간 피드백

### 핵심 기술 요소
- 파일명 패턴: `01-genesis-01.html`, `02-genesis-02.html` 등
- 장 번호 자동 추출: 정규식 `/[0-9]{2,3}-([a-zA-Z0-9]+)-([0-9]+)\.html/`
- Storage 병렬 업로드 + DB 일괄 삽입
- 실시간 진행률 표시 및 상태 피드백

---

## Phase 1: FileUpload.tsx 컴포넌트 개선 (우선순위)

### 1. 파일명 검증 및 장 번호 자동 추출 로직 구현

**목표**: FileUpload.tsx에 파일명 패턴 검증 및 장 번호 자동 추출 로직을 구현

**구현 내용**:
- [ ] `extractChapterFromFileName` 함수 구현: 파일명에서 장 번호 추출 로직
- [ ] `validateFileName` 함수 구현: 파일명 패턴 검증 및 오류 메시지 반환
- [ ] 기존 `chapter` 상태 및 입력 필드 제거
- [ ] 파일 선택 시 자동 검증 로직 추가
- [ ] 검증 실패 파일에 대한 오류 처리 구현

**기술 세부사항**:
- 정규식 패턴: `/[0-9]{2,3}-([a-zA-Z0-9]+)-([0-9]+)\.html/`
- 장 번호 범위: 1-150
- 기존 `toSlug`, `getTestamentFolder` 함수 재사용

**검증 기준**:
- [ ] 파일명 패턴 검증이 정확히 동작하는지 확인
- [ ] 장 번호 자동 추출이 올바르게 작동하는지 확인
- [ ] 기존 장 번호 입력 필드가 제거되었는지 확인
- [ ] 검증 실패 파일에 대한 적절한 오류 메시지가 표시되는지 확인

---

### 2. 파일 검증 테이블 UI 구현

**목표**: 기존 단순 파일 리스트를 테이블 형태로 개선하여 각 파일의 검증 결과, 크기, 장 번호, 상태를 시각적으로 표시

**구현 내용**:
- [ ] `FileValidationTable` 컴포넌트 구현: 파일 상태 테이블 UI
- [ ] 파일별 상태 아이콘 시스템 구현 (적합/부적합/경고)
- [ ] 파일 크기 표시 및 포맷팅 로직 추가
- [ ] 파일 제거 기능 구현 (개별 파일 삭제)
- [ ] 오류 메시지 툴팁 또는 모달 구현
- [ ] 기존 단순 파일 리스트를 테이블로 교체

**기술 세부사항**:
- 기존 드래그앤드롭 영역 유지
- 테이블 디자인: 기존 다크모드 스타일과 일치
- 파일 크기: KB 단위로 표시
- 상태 아이콘: ✅❌⚠️

**검증 기준**:
- [ ] 파일 검증 테이블이 올바르게 렌더링되는지 확인
- [ ] 각 파일의 상태 아이콘이 정확히 표시되는지 확인
- [ ] 파일 크기와 장 번호가 올바르게 표시되는지 확인
- [ ] 파일 제거 기능이 정상 동작하는지 확인
- [ ] 오류 메시지가 적절히 표시되는지 확인

---

### 3. 진행률 표시 컴포넌트 구현

**목표**: 업로드 진행 상황을 실시간으로 표시하는 `UploadProgress` 컴포넌트를 구현

**구현 내용**:
- [ ] `UploadProgress` 컴포넌트 구현: 진행률 바 및 상태 표시
- [ ] 진행률 계산 로직 구현 (`current/total * 100`)
- [ ] 업로드 상태에 따른 UI 변경 로직 구현
- [ ] 애니메이션 효과 추가 (진행률 바 전환)
- [ ] FileUpload.tsx에 진행률 컴포넌트 통합
- [ ] 업로드 상태 관리 로직 개선

**기술 세부사항**:
- 기존 gradient 스타일과 일치
- 진행률 바: 0.3초 부드러운 전환 효과
- 상태 구분: 업로드 준비 완료 vs 진행 중

**검증 기준**:
- [ ] 진행률 바가 올바르게 표시되는지 확인
- [ ] 진행률 계산이 정확한지 확인
- [ ] 업로드 상태에 따른 UI 변경이 정상 동작하는지 확인
- [ ] 애니메이션 효과가 부드럽게 작동하는지 확인
- [ ] 완료된 파일 수와 전체 파일 수가 정확히 표시되는지 확인

---

### 4. 일괄 업로드 로직 구현

**목표**: 기존 개별 파일 업로드 로직을 일괄 처리 방식으로 개선

**구현 내용**:
- [ ] `createMaterialMetadata` 함수 구현: 파일별 메타데이터 생성
- [ ] Storage 병렬 업로드 로직 구현 (`Promise.allSettled` 사용)
- [ ] DB 일괄 삽입 로직 구현 (배치 처리)
- [ ] 에러 처리 및 롤백 로직 강화
- [ ] 업로드 결과 수집 및 상태 업데이트 로직 개선
- [ ] 기존 `handleUpload` 함수를 일괄 처리 방식으로 교체

**기술 세부사항**:
- 기존 Supabase 클라이언트 및 업로드 로직 재사용
- 병렬 업로드: 최대 5개 동시 처리로 제한
- DB 삽입 실패 시 Storage 파일 정리 로직 구현

**검증 기준**:
- [ ] 다중 파일 일괄 업로드가 정상 동작하는지 확인
- [ ] 각 파일의 장 번호가 올바르게 추출되어 저장되는지 확인
- [ ] 병렬 업로드 성능이 개선되었는지 확인
- [ ] 에러 처리 및 롤백이 정상 동작하는지 확인
- [ ] 업로드 결과가 정확히 수집되는지 확인

---

### 5. 사용자 경험 개선 및 최적화

**목표**: 직관적인 인터페이스와 즉시 피드백을 제공하는 완성된 다중 파일 업로드 시스템을 구현

**구현 내용**:
- [ ] 드래그앤드롭 영역 안내 메시지 업데이트
- [ ] 업로드 버튼 상태 관리 로직 개선 (검증 실패 파일이 있을 때 비활성화)
- [ ] 토스트 알림 메시지 개선 및 상세화
- [ ] 파일 선택 시 즉시 피드백 제공
- [ ] 업로드 완료 후 상태 초기화 로직 개선
- [ ] 반응형 디자인 및 접근성 개선

**기술 세부사항**:
- 기존 토스트 시스템 재사용
- 업로드 버튼: 모든 파일이 검증을 통과했을 때만 활성화
- 파일 선택 즉시 검증 결과를 표시하여 사용자 경험 향상

**검증 기준**:
- [ ] 드래그앤드롭 영역의 안내 메시지가 명확한지 확인
- [ ] 업로드 버튼 상태 관리가 올바르게 동작하는지 확인
- [ ] 토스트 알림이 적절하고 상세한지 확인
- [ ] 파일 선택 시 즉시 피드백이 제공되는지 확인
- [ ] 업로드 완료 후 상태 초기화가 정상 동작하는지 확인

---

## Phase 2: Supabase DB 구조 검증 및 최적화 (후반부 단독 섹션)

### 6. 현재 DB 구조 검증 및 확인

**목표**: 현재 b_materials 테이블 구조가 다중 파일 업로드 요구사항을 충족하는지 검증

**현재 테이블 구조** (b-materia_table_column.csv 기준):
```sql
CREATE TABLE b_materials (
  id UUID PRIMARY KEY NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE,
  updated_at TIMESTAMP WITH TIME ZONE,
  category_id UUID NOT NULL,
  chapter INTEGER NOT NULL,
  file_name TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  file_size BIGINT NOT NULL,
  mime_type TEXT NOT NULL
);
```

**구현 내용**:
- [ ] 현재 테이블 구조와 다중 파일 업로드 요구사항 매핑 검증
- [ ] 누락된 컬럼 확인 (현재 모든 필요 컬럼이 존재함)
- [ ] 데이터 타입 및 제약조건 검증
- [ ] 기존 데이터와의 호환성 확인
- [ ] 다중 파일 업로드 로직과의 연동 테스트

**기술 세부사항**:
- ✅ `file_size`: BIGINT 타입으로 파일 크기 저장 가능
- ✅ `mime_type`: TEXT 타입으로 파일 타입 저장 가능  
- ✅ `updated_at`: TIMESTAMP WITH TIME ZONE으로 수정 시각 추적 가능
- ✅ 모든 필수 컬럼이 이미 존재하여 추가 마이그레이션 불필요

**검증 기준**:
- [ ] 현재 테이블 구조가 다중 파일 업로드 요구사항을 충족하는지 확인
- [ ] 기존 데이터가 새로운 업로드 로직과 호환되는지 확인
- [ ] 컬럼 데이터 타입이 적절한지 확인
- [ ] 다중 파일 업로드 테스트가 정상 동작하는지 확인

---

### 7. 제약조건 및 인덱스 최적화

**목표**: b_materials 테이블의 데이터 무결성을 보장하는 제약조건과 성능 최적화를 위한 인덱스를 추가

**구현 내용**:
- [ ] 장 번호 범위 제약조건 추가 (1-150)
- [ ] 성능 최적화 인덱스 생성 (`category_id`, `chapter`, `file_name`, `created_at`)
- [ ] 외래키 제약조건 검증 및 강화
- [ ] 인덱스 생성 후 성능 테스트
- [ ] 제약조건 위반 시 오류 처리 로직 검증
- [ ] 인덱스 사용률 모니터링 설정

**기술 세부사항**:
- 제약조건 추가 시 기존 데이터와의 충돌 여부를 먼저 확인
- 인덱스: 검색 성능 향상을 위해 복합 인덱스도 고려
- 개발 환경에서 충분한 테스트 후 적용

**검증 기준**:
- [ ] 장 번호 범위 제약조건이 정상 동작하는지 확인
- [ ] 인덱스가 올바르게 생성되었는지 확인
- [ ] 검색 성능이 개선되었는지 확인
- [ ] 제약조건 위반 시 적절한 오류가 발생하는지 확인
- [ ] 외래키 제약조건이 데이터 무결성을 보장하는지 확인

---

### 8. 자동 업데이트 트리거 구현

**목표**: b_materials 테이블의 `updated_at` 컬럼이 자동으로 업데이트되도록 트리거를 구현

**구현 내용**:
- [ ] `update_updated_at_column` 함수 구현
- [ ] b_materials 테이블에 트리거 생성
- [ ] 트리거 동작 테스트 (INSERT, UPDATE 시 `updated_at` 자동 업데이트)
- [ ] 트리거 성능 영향 분석
- [ ] 트리거 오류 처리 로직 구현
- [ ] 트리거 로깅 및 모니터링 설정

**기술 세부사항**:
- 기존 `update_updated_at_column` 함수가 있다면 재사용, 없다면 새로 생성
- 트리거: BEFORE UPDATE 시점에 동작하도록 설정
- 트리거 성능 영향을 최소화하기 위해 최적화

**검증 기준**:
- [ ] `updated_at` 컬럼이 레코드 수정 시 자동으로 업데이트되는지 확인
- [ ] 트리거가 정상적으로 동작하는지 확인
- [ ] 트리거 성능에 문제가 없는지 확인
- [ ] 트리거 오류가 적절히 처리되는지 확인
- [ ] 데이터 변경 이력이 올바르게 추적되는지 확인

---

## 구현 우선순위 및 의존성

### Phase 1: FileUpload.tsx 컴포넌트 개선 (우선순위)
1. 파일명 검증 및 장 번호 자동 추출 로직 구현
2. 파일 검증 테이블 UI 구현
3. 진행률 표시 컴포넌트 구현
4. 일괄 업로드 로직 구현
5. 사용자 경험 개선 및 최적화

### Phase 2: Supabase DB 구조 검증 및 최적화 (후반부 단독 섹션)
6. 현재 DB 구조 검증 및 확인
7. 제약조건 및 인덱스 최적화
8. 자동 업데이트 트리거 구현

### 의존성 관계
- Phase 1의 각 단계는 순차적으로 진행
- Phase 2는 Phase 1 완료 후 독립적으로 진행 가능
- DB 구조 검증 및 최적화는 기존 기능에 영향을 주지 않도록 주의

---

## 테스트 시나리오

### 기능 테스트
- [ ] 기존 단일 파일 업로드: 현재 기능이 정상 동작하는지 확인
- [ ] 다중 파일 업로드: 여러 파일 동시 업로드 테스트
- [ ] 파일명 패턴 검증: 다양한 파일명 패턴 테스트
  - `01-genesis-01.html` (정상)
  - `genesis-01.html` (오류)
  - `01-genesis-01.txt` (오류)
- [ ] 장 번호 자동 추출: 파일명에서 장 번호 정확히 추출되는지 확인

### 데이터 무결성 테스트
- [ ] DB 컬럼 추가: 새로운 컬럼들이 정상적으로 추가되는지 확인
- [ ] 제약조건 검증: 장 번호 범위 제약조건이 정상 동작하는지 확인
- [ ] 인덱스 성능: 검색 성능이 개선되는지 확인
- [ ] 트리거 동작: `updated_at` 자동 업데이트가 정상 동작하는지 확인

### 성능 테스트
- [ ] 대용량 파일 업로드: 10MB 이상 파일 업로드 테스트
- [ ] 다중 파일 동시 업로드: 10개 이상 파일 동시 업로드 테스트
- [ ] 메모리 사용량: 업로드 중 메모리 사용량 모니터링
- [ ] 네트워크 오류: 업로드 중 네트워크 오류 상황 테스트

### 사용자 경험 테스트
- [ ] 파일 검증 피드백: 부적합 파일에 대한 즉시 피드백 확인
- [ ] 진행률 표시: 업로드 진행률이 정확히 표시되는지 확인
- [ ] 오류 처리: 다양한 오류 상황에서 적절한 메시지 표시 확인
- [ ] 반응형 디자인: 모바일/태블릿에서 UI 정상 동작 확인

---

## 구현 체크리스트

### DB 구조 검증 (현재 상태 확인)
- [x] `file_size` 컬럼 존재 확인 (BIGINT 타입)
- [x] `mime_type` 컬럼 존재 확인 (TEXT 타입)
- [x] `updated_at` 컬럼 존재 확인 (TIMESTAMP WITH TIME ZONE)
- [ ] 장 번호 범위 제약조건 추가 (1-150)
- [ ] 성능 최적화 인덱스 추가
- [ ] 자동 업데이트 트리거 설정

### 코드 구현
- [ ] 파일명 검증 함수 구현
- [ ] 장 번호 자동 추출 함수 구현
- [ ] FileUpload.tsx UI 개선
- [ ] 일괄 업로드 로직 구현
- [ ] 에러 처리 강화
- [ ] 진행률 표시 구현

### 테스트 및 검증
- [ ] 기존 기능 정상 동작 확인
- [ ] 새로운 기능 정상 동작 확인
- [ ] DB 구조 검증 완료
- [ ] 성능 테스트 완료
- [ ] 사용자 경험 테스트 완료
- [ ] 오류 상황 테스트 완료

---

## 완료 기준

### Phase 1 완료 기준
- [ ] 다중 파일 업로드 기능이 정상 동작
- [ ] 파일명에서 장 번호 자동 추출이 정확히 작동
- [ ] 사용자 경험이 크게 향상됨
- [ ] 기존 기능이 정상 동작함

### Phase 2 완료 기준
- [ ] DB 구조가 다중 파일 업로드 요구사항을 충족함
- [ ] 데이터 무결성이 보장됨
- [ ] 성능이 최적화됨
- [ ] 제약조건 및 인덱스가 적절히 설정됨

### 전체 프로젝트 완료 기준
- [ ] 모든 TODO 항목이 완료됨
- [ ] 테스트 시나리오가 모두 통과됨
- [ ] 사용자 요구사항이 모두 충족됨
- [ ] 시스템이 안정적으로 동작함

---

**이 TODO 리스트를 기반으로 구현하면 현재 단일 파일 업로드의 한계를 완전히 해결하고, 사용자 경험을 크게 향상시킬 수 있습니다.** 